---
title: "fdcoexist"
author:
    - Pierre Denelle, Matthias GreniÃ©, Cyrille Violle and Caroline M. Tucker
date: "`r format(Sys.time(), '%d %B %Y')`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      fig.width = 8, fig.height = 10.5)

# Packages ---------------------------------------------------------------------
suppressPackageStartupMessages({
    suppressWarnings({
        library("cowplot")
        library("tidyverse")
        library("directlabels")
    })
})
# Functions --------------------------------------------------------------------
compute_moments = function(simulation_routine, trait_df = traits) {
    # CWM computation
    ab_rel = (simulation_routine$compo[,,150] /
                  rowSums(simulation_routine$compo[,,150]))
    cwm_df = ab_rel %*% trait_df
    # Values stored in moments_df
    moments_df = as.data.frame(cwm_df)
    colnames(moments_df) = "cwm"
    moments_df = tibble::rownames_to_column(moments_df, "patch")
    moments_df$env = seq(patches)
    # Add CWV
    cwv_df = (ab_rel %*% trait_df^2) - cwm_df^2
    cwv_df = as.data.frame(cwv_df)
    colnames(cwv_df) = "cwv"
    cwv_df = tibble::rownames_to_column(cwv_df, "patch")
    moments_df = dplyr::left_join(moments_df, cwv_df, by = "patch")
    
    return(moments_df)
}

# Compute a data.frame of number of individuals in function of optimal trait
# for competition and growth
landscape_df = function(multiple_traits_scenario, trait_df, trait_weights,
                        time = 150) {
    
    growth_traits = subset(trait_weights, growth_weight != 0)$trait
    compet_traits = subset(trait_weights, compet_weight != 0)$trait
    
    
    population_df = multiple_traits_scenario$compo[,,time] %>%
        as.data.frame() %>%
        rownames_to_column("patch") %>%  # Add patch names as column
        # Transform to tidy data.frame (define name of columns and column name
        # for values)
        gather("species", "N", -patch)
    
    growth_df = enframe(rowMeans(trait_df[, growth_traits, drop = FALSE]),
                        "species", "growth_trait")
    
    compet_df = enframe(abs(rowMeans(trait_df[, compet_traits, drop = FALSE]) -
                                12.5), "species", "compet_dist")
    
    population_df %>%
        inner_join(growth_df, by = "species") %>%
        inner_join(compet_df, by = "species") %>%
        # Add patch number as a new column and compute distance to optimal value
        mutate(patch_optim = gsub("patches", "", patch) %>%
                   as.numeric(),
               optim_dist = abs(growth_trait - patch_optim))
}

# This function tidy a list of simulation routine to a single data.frame
# suitable to make figures.
tidy_simulation_list = function(simulation_list, set_of_traits, trait_scenarios,
                                time = 150, scenar_names = names(trait_scenarios)) {
    simulation_list %>%
        names() %>%
        # Tidy single simulations
        lapply(tidy_simulation,
               given_simul = simulation_list,
               given_traits = set_of_traits,
               given_trait_scenar = trait_scenarios,
               time = time) %>%
        # Re-add names
        set_names(nm = names(simulation_list)) %>%
        # Join into single data.frame
        bind_rows(.id = "scenario") %>%
        # Compute pre-CWMs
        mutate_at(vars(contains("trait")), funs(cwm = rel_abund * .)) %>%
        mutate(scenario = fct_relevel(scenario, scenar_names))
}

tidy_simulation = function(scenario, given_simul, given_traits,
                           given_trait_scenar, time = 150) {
    landscape_df(given_simul[[scenario]], given_traits,
                 trait_scenarios[[scenario]], time = time) %>%
        inner_join(given_traits %>%
                       as.data.frame() %>%
                       rownames_to_column("species"),
                   by = "species") %>%
        group_by(patch) %>%
        mutate(rel_abund = N/sum(N)) %>%
        ungroup()
}
# Initial parameters -----------------------------------------------------------
suppressMessages(devtools::load_all())

n_patches <- 25   # Number of patches
n_species <- 100  # Number of species
n_gen     <- 150  # Length of model run (generations)
initpop   <- 50   # initial population size
n_traits  <- 3    # number of traits
k         <- 1.15 # Maximum growth rate
env_width <- seq(10, 10, length.out = n_patches)  # Envtal filter strength
var_width <- seq(10, 1, length.out = n_patches) # Varying envtal filter strength

# Competition + Dispersion coefficients
B = 1/500 # Scalar for intraspecific competition
A =  B/n_species	# Alpha scalar
d = 0.05 # Dispersal percentage

# Generate environment
env <- seq(n_patches)

# Array for simulations
composition <- array(NA, dim = c(n_patches, n_species, n_gen),
                     dimnames = list(paste0("patches", seq(n_patches)),
                                     paste0("species", seq(n_species)),
                                     paste0("time", seq(n_gen))))
names(env) <- dimnames(composition)[[1]]

composition[,, "time1"] <- initpop

# Define scenarios -------------------------------------------------------------
# Scenarios on traits affecting growth and competition
trait_scenarios = list(
    R0A0 = data.frame(trait = paste0("trait", 1:3),
                      growth_weight = c(1, 0, 0),
                      compet_weight = c(0, 0, 1)),
    R0A100 = data.frame(trait = paste0("trait", 1:3),
                        growth_weight = c(1, 0, 0),
                        compet_weight = c(0, 1, 0)),
    R10A90   = data.frame(trait = paste0("trait", 1:3),
                          growth_weight = c(0.90, 0.10, 0),
                          compet_weight = c(0,    0.90, 0.10)),
    R25A75   = data.frame(trait = paste0("trait", 1:3),
                          growth_weight = c(0.75, 0.25, 0),
                          compet_weight = c(0,    0.75, 0.25)),
    R50A50   = data.frame(trait = paste0("trait", 1:3),
                          growth_weight = c(0.5, 0.5, 0),
                          compet_weight = c(0,   0.5, 0.5)),
    R75A25   = data.frame(trait = paste0("trait", 1:3),
                          growth_weight = c(0.25, 0.75, 0),
                          compet_weight = c(0,    0.25, 0.75)),
    R90A10   = data.frame(trait = paste0("trait", 1:3),
                          growth_weight = c(0.10, 0.90, 0),
                          compet_weight = c(0,    0.10, 0.90)),
    R100A0   = data.frame(trait = paste0("trait", 1:3),
                          growth_weight = c(0, 1, 0),
                          compet_weight = c(0, 0, 1)),
    R100A100 = data.frame(trait = paste0("trait", 1:3),
                          growth_weight = c(0, 1, 0),
                          compet_weight = c(0, 1, 0))
)


# Define meta-function to run all analyses with many trait levels --------------

meta_simul = function(seed_number) {
    set.seed(seed_number)
    uncor_traits = generate_cor_traits(n_patches, n_species, n_traits - 1,
                                       cor_coef = 0)
    set.seed(seed_number)
    low_cor_traits = generate_cor_traits(n_patches, n_species, n_traits - 1,
                                         cor_coef = 0.3)
    
    set.seed(seed_number)
    high_cor_traits = generate_cor_traits(n_patches, n_species, n_traits - 1,
                                          cor_coef = 0.7)
    all_cor = list(uncor    = uncor_traits,
                   low_cor  = low_cor_traits,
                   high_cor = high_cor_traits)
    
    all_env = list(constant = env_width,
                   varying  = var_width)
    
    all_compet = list(no_compet = list(A = 0, B = B),
                      compet    = list(A = A, B = B))
    
    all_facets = expand.grid(compet_status = names(all_compet),
                             env_width     = names(all_env),
                             cor_level     = names(all_cor),
                             scenario      = names(trait_scenarios))
    
    apply(all_facets, 1, function(given_row) {
        multigen(traits = all_cor[[given_row[["cor_level"]]]],
                 trait_weights = trait_scenarios[[given_row[["scenario"]]]],
                 env = env,
                 time = n_gen,
                 species = n_species,
                 patches = n_patches,
                 composition = composition,
                 A = all_compet[[given_row[["compet_status"]]]][["A"]],
                 B = all_compet[[given_row[["compet_status"]]]][["B"]],
                 d = d,
                 k = k,
                 width = all_env[[given_row[["env_width"]]]]) %>%
            landscape_df(all_cor[[given_row[["cor_level"]]]],
                         trait_scenarios[[given_row[["scenario"]]]],
                         time = 150) %>%
            inner_join(all_cor[[given_row[["cor_level"]]]] %>%
                           as.data.frame() %>%
                           rownames_to_column("species"),
                       by = "species") %>%
            group_by(patch) %>%
            mutate(rel_abund = N/sum(N)) %>%
            ungroup() %>%
            mutate(compet_status = given_row[["compet_status"]],
                   env_width     = given_row[["env_width"]],
                   cor_level     = given_row[["cor_level"]],
                   scenario      = given_row[["scenario"]],
                   seed_number = seed_number) %>%
            select(seed_number, compet_status, env_width, cor_level, scenario,
                   everything())
    }) %>%
        bind_rows() %>%
        filter(N != 0) %>%  # Take out absent species
        mutate_at(vars(contains("trait")), funs(cwm = rel_abund * .)) %>%
        mutate(scenario = fct_relevel(scenario, names(trait_scenarios)),
               patch_optim = as.numeric(gsub("patches", "", patch))) %>%
        group_by(seed_number, compet_status, env_width, cor_level, scenario,
                 patch) %>%
        summarise(trait1_cwm  = sum(trait1_cwm),
                  trait2_cwm  = sum(trait2_cwm),
                  trait3_cwm  = sum(trait3_cwm),
                  trait1_var  = var(trait1),
                  trait2_var  = var(trait2),
                  trait3_var  = var(trait3),
                  patch_optim = unique(patch_optim))
}

# Generate traits --------------------------------------------------------------
trait_seed = 5
# Make traits with different correlations
set.seed(trait_seed)
uncor_traits = generate_cor_traits(n_patches, n_species, n_traits - 1,
                                   cor_coef = 0)
set.seed(trait_seed)
low_cor_traits = generate_cor_traits(n_patches, n_species, n_traits - 1,
                                     cor_coef = 0.3)

set.seed(trait_seed)
high_cor_traits = generate_cor_traits(n_patches, n_species, n_traits - 1,
                                      cor_coef = 0.7)


# Graphical parameters ---------------------------------------------------------
theme_set(theme_bw(12))

# Graphical functions ----------------------------------------------------------
label_scenar_facets = function(scenar_name) {
    scenar_name %>%
        as.character() %>%
        str_remove("R") %>%
        str_split("A") %>%
        map_chr(~paste0("Growth = ",  .x[1], "%\n",
                        "Compet. = ", .x[2], "%"))
}

facet_scenar = facet_wrap(vars(scenario),
                          labeller = labeller(scenario = label_scenar_facets))

# Plot the relationship between species abundances along the environment in the
# different scenarios
fig_abund_env = function(simul_df, simul_label) {
    ggplot(simul_df %>%
               filter(N >= 2), aes(patch_optim, N)) +
        geom_point(shape = ".") +
        geom_smooth() +
        facet_scenar +
        labs(x = "Environmental value",
             y = "Species Abundance (gen. = 150)",
             subtitle = simul_label)
}

# Plot the relationship between the CWM of the different trait along the
# environment for the different scenarios
fig_cwm_env = function(simul_df, simul_label) {
    simul_df %>%
        filter(N >= 2) %>%
        group_by(scenario, patch) %>%
        summarise_at(vars(contains("cwm")), sum, na.rm = TRUE) %>%
        mutate(patch_optim = gsub("patches", "", patch) %>%
                   as.numeric()) %>%
        gather("cwm_name", "cwm_value", contains("cwm")) %>%
        ggplot(aes(patch_optim, cwm_value, color = cwm_name)) +
        geom_point() +
        geom_smooth() +
        facet_scenar +
        scale_color_discrete(labels = c(trait1_cwm = "Trait 1",
                                        trait2_cwm = "Trait 2",
                                        trait3_cwm = "Trait 3")) +
        labs(x = "Environment",
             y = "Community-Weighted Mean (CWM)",
             color = NULL,
             subtitle = simul_label) +
        theme(legend.position = "top")
}

# Plot the relationship between patch CWMs along the environment considering
# total abundance
fig_cwm_env_abund = function(simul_df, simul_label, n_bins = 24,
                             given_trans = "identity") {
    simul_df %>%
        group_by(scenario, patch) %>%
        summarise_at(vars(contains("cwm"), N), sum) %>%
        mutate(patch_optim = gsub("patches", "", patch) %>%
                   as.numeric()) %>%
        gather("cwm_name", "cwm_value", contains("cwm")) %>%
        ungroup() %>%
        ggplot(aes(patch_optim, cwm_value, z = N)) +
        stat_summary_2d(bins = n_bins) +
        facet_grid(vars(scenario), vars(cwm_name),
                   labeller = labeller(scenario = label_scenar_facets,
                                       cwm_name = label_value)) +
        scale_fill_viridis_c(trans = given_trans, option = "E") +
        labs(x = "Environment",
             y = "Community-Weighted Mean (CWM)",
             fill = "Total Abundance",
             subtitle = simul_label) +
        theme(legend.position = "top")
}

# Relationship betwee, species trait values along the enviroment showing their
# local abundances for the different traits considered
fig_ind_landscape = function(simul_df, simul_label, n_bins = 22,
                             given_trans = "identity") {
    
    simul_df <- simul_df %>%
        select(-contains("cwm")) %>%
        gather("trait_name", "trait_value", contains("trait"))
    
    simul_df_cwm <- simul_df %>%
        group_by(scenario, patch, trait_name) %>%
        summarise(cwm = weighted.mean(trait_value, N))
    
    simul_df2 <- left_join(simul_df, simul_df_cwm,
                           by = c("scenario", "patch", "trait_name"))
    
    ggplot(simul_df2 %>%
               filter(N > 0),
           aes(patch_optim, trait_value, z = N)) +
        stat_summary_2d(geom = "raster", bins = n_bins, interpolate = TRUE) +
        geom_line(aes(patch_optim, cwm, color = "firebrick"), size = 1) +
        facet_grid(vars(scenario), vars(trait_name),
                   labeller = labeller(scenario = label_scenar_facets,
                                       trait_name = function(x) gsub("_", " ",
                                                                     x))) +
        scale_fill_viridis_c(trans = given_trans, option = "E") +
        scale_color_manual(name = "CWM", values = c(firebrick = "grey80"),
                           labels = "") +
        labs(x = "Environment",
             y = "Trait Value",
             fill = "Species Abundance",
             subtitle = simul_label) +
        guides(colour = guide_legend(override.aes = list(size = 1,
                                                         color = "grey50"))) +
        theme(legend.position = "top")
}
```

```{r}
library("furrr")

plan(multiprocess)
tictoc::tic()

total_runs = 60

first_simuls = future_map(seq(total_runs), function(x) {
    devtools::load_all()
    
    meta_simul(x)
})
tictoc::toc()

first_simuls_r2 = first_simuls %>%
    map(~.x %>%
        gather("cwm_name", "cwm_value", ends_with("cwm")) %>%
        group_by(cwm_name, add = TRUE) %>%
        do(mod_cwm_env = lm(cwm_value ~ patch_optim, data = .)) %>%
        ungroup() %>%
        mutate(mod_glance = lapply(mod_cwm_env, broom::glance)) %>%
        unnest(mod_glance)) %>%
    bind_rows()

first_simuls_var = first_simuls %>%
    map(~.x %>%
            select(-ends_with("cwm"))) %>%
    bind_rows() %>%
    gather("var_name", "var_value", ends_with("var"))
```

```{r}
ggplot(first_simuls_r2, aes(scenario, r.squared)) +
    geom_boxplot(aes(fill = fct_rev(cor_level)),
                 position = position_dodge(width = 0.9)) +
    facet_grid(rows = vars(compet_status), cols = vars(env_width, cwm_name),
               labeller =
                   labeller(compet_status = c(compet = "Competition",
                                              no_compet = "Only intra comp."),
                            env_width     = c(constant = "Constant\nEnv. Filter Strength",
                                              varying  = "Varying\nEnv. Filter Strength"))) +
    ylim(0, NA) +
    scale_fill_viridis_d("Trait\nCorrelations",
                         labels = c(uncor   = "r = 0",
                                    low_cor  = "r = 0.3",
                                    high_cor = "r = 0.7")) +
    labs(subtitle = paste0("R2 of trait2 CWM ~ environment; N = ", total_runs),
         x = "Scenario",
         y = expression("R"^2)) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "top")
```

```{r}
ggplot(first_simuls_var, aes(scenario, var_value)) +
    geom_boxplot(aes(fill = fct_rev(cor_level)),
                 position = position_dodge(width = 0.9)) +
    facet_grid(rows = vars(env_width, compet_status), cols = vars(var_name),
               labeller =
                   labeller(compet_status = c(compet = "Competition",
                                              no_compet = "Only intra comp."),
                            env_width     = c(constant = "Constant\nEnv. Filter Strength",
                                              varying  = "Varying\nEnv. Filter Strength")),
               scales = "free_y") +
    ylim(0, NA) +
    scale_fill_viridis_d("Trait\nCorrelations",
                         labels = c(uncor    = "r = 0",
                                    low_cor  = "r = 0.3",
                                    high_cor = "r = 0.7")) +
    labs(subtitle = paste0("Trait Variance across Patches; N = ", total_runs),
         x = "Scenario",
         y = expression("R"^2)) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "top")
```

