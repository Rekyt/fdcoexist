---
title: "fdcoexist exploring single simulations"
author:
    - Pierre Denelle, Matthias Grenié, Cyrille Violle, François Munoz and Caroline M. Tucker
date: "`r format(Sys.time(), '%d %B %Y')`"
output: pdf_document
vignette: >
  %\VignetteIndexEntry{Full equation of the model}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      error = TRUE, fig.width = 8, fig.height = 10.5)

# Packages ---------------------------------------------------------------------
suppressPackageStartupMessages({
    suppressWarnings({
        library("cowplot")
        library("tidyverse")
        library("directlabels")
    })
})
# Functions --------------------------------------------------------------------
# Compute a data.frame of number of individuals in function of optimal trait
# for competition and growth
landscape_df = function(multiple_traits_scenario, trait_df, trait_weights,
                        time = n_gen) {
    
    growth_traits = subset(trait_weights, growth_weight != 0)$trait
    compet_traits = subset(trait_weights, compet_weight != 0)$trait
    
    
    population_df = multiple_traits_scenario$compo[,,time] %>%
        as.data.frame() %>%
        rownames_to_column("patch") %>%  # Add patch names as column
        # Transform to tidy data.frame (define name of columns and column name
        # for values)
        gather("species", "N", -patch)
    
    growth_df = enframe(rowMeans(trait_df[, growth_traits, drop = FALSE]),
                        "species", "growth_trait")
    
    compet_df = enframe(abs(rowMeans(trait_df[, compet_traits, drop = FALSE]) -
                                12.5), "species", "compet_dist")
    
    population_df %>%
        inner_join(growth_df, by = "species") %>%
        inner_join(compet_df, by = "species") %>%
        # Add patch number as a new column and compute distance to optimal value
        mutate(patch_optim = gsub("patches", "", patch) %>%
                   as.numeric(),
               optim_dist = abs(growth_trait - patch_optim))
}

# This function tidy a list of simulation routine to a single data.frame
# suitable to make figures.
tidy_simulation_list = function(simulation_list, set_of_traits, trait_scenarios,
                                time = n_gen, scenar_names = names(trait_scenarios)) {
    simulation_list %>%
        names() %>%
        # Tidy single simulations
        lapply(tidy_simulation,
               given_simul = simulation_list,
               given_traits = set_of_traits,
               given_trait_scenar = trait_scenarios,
               time = time) %>%
        # Re-add names
        set_names(nm = names(simulation_list)) %>%
        # Join into single data.frame
        bind_rows(.id = "scenario") %>%
        # Compute pre-CWMs
        mutate_at(vars(contains("trait")), funs(cwm = rel_abund * .)) %>%
        mutate(scenario = fct_relevel(scenario, scenar_names))
}

tidy_simulation = function(scenario, given_simul, given_traits,
                           given_trait_scenar, time = n_gen) {
    landscape_df(given_simul[[scenario]], given_traits,
                 trait_scenarios[[scenario]], time = time) %>%
        inner_join(given_traits %>%
                       as.data.frame() %>%
                       rownames_to_column("species"),
                   by = "species") %>%
        group_by(patch) %>%
        mutate(rel_abund = N/sum(N)) %>%
        ungroup()
}
# Initial parameters -----------------------------------------------------------
suppressMessages(devtools::load_all())

n_patches <- 25   # Number of patches
n_species <- 100  # Number of species
n_gen     <- 150  # Length of model run (generations)
initpop   <- 50   # initial population size
n_traits  <- 4    # number of traits
k         <- 1.2  # Maximum growth rate
env_width <- seq(10, 10, length.out = n_patches)  # Envtal filter strength
var_width <- seq(10, 1, length.out = n_patches) # Varying envtal filter strength

# Competition + Dispersion coefficients
B = 1e-2 # Scalar for intraspecific competition
A = 1e-5 # Alpha scalar
d = 0.0 # Dispersal percentage

# Hierarchical coefficients
H = 0.6
th_max = 25

# Generate environment
env <- seq(n_patches)

# Array for simulations
composition <- array(NA, dim = c(n_patches, n_species, n_gen),
                     dimnames = list(paste0("patches", seq(n_patches)),
                                     paste0("species", seq(n_species)),
                                     paste0("time", seq(n_gen))))
names(env) <- dimnames(composition)[[1]]

composition[,, "time1"] <- initpop

# Define scenarios -------------------------------------------------------------
# Scenarios on traits affecting growth and competition
trait_scenarios = c("R0A0H0", "R0A100H0", "R10A90H0", "R25A75H0", "R50A50H0",
                    "R75A25H0", "R90A10H0", "R100A0H0", "R100A100H0",
                    "R100A100H100")

names(trait_scenarios) = trait_scenarios

trait_scenarios = lapply(trait_scenarios, function(scenar_name) {
    growth = as.numeric(gsub("R(\\d+)A\\d+H\\d+", "\\1", scenar_name, perl = TRUE))
    compet = as.numeric(gsub("R\\d+A(\\d+)H\\d+", "\\1", scenar_name, perl = TRUE))
    hier   = as.numeric(gsub("R\\d+A\\d+H(\\d+)", "\\1", scenar_name, perl = TRUE))
    
    create_trait_weights(growth, compet, hier)
})

# Generate traits --------------------------------------------------------------
trait_seed = 5
# Make traits with different correlations
set.seed(trait_seed)
uncor_traits = generate_cor_traits(n_patches, n_species, n_traits - 1,
                                   cor_coef = 0)
set.seed(trait_seed)
low_cor_traits = generate_cor_traits(n_patches, n_species, n_traits - 1,
                                     cor_coef = 0.3)

set.seed(trait_seed)
high_cor_traits = generate_cor_traits(n_patches, n_species, n_traits - 1,
                                      cor_coef = 0.7)

# Graphical parameters ---------------------------------------------------------
theme_set(theme_bw(12) +
              theme(axis.text.x = element_text(angle = 45),
                    legend.text = element_text(angle = 45)))

# Graphical functions ----------------------------------------------------------
label_scenar_facets = function(scenar_name) {
    scenar_prop = scenar_name %>%
        as.character() %>%
        str_remove("R") %>%
        str_split("A") %>%
        lapply(str_split, pattern = "H") %>%
        unlist()
    
        paste0("Growth = ",  scenar_prop[1], "%\n",
               "Compet. = ", scenar_prop[2], "%\n",
               "Hier. = ",   scenar_prop[3], "%")
}

facet_scenar = facet_wrap(vars(scenario),
                          labeller = labeller(scenario = label_scenar_facets))

label_compet_env = labeller(compet_status = c(compet = "Competition",
                                              no_compet = "Only intra comp."),
                            env_width     = c(constant = "Constant\nEnv. Filter Strength",
                                              varying  = "Varying\nEnv. Filter Strength"))

lab_cor =c(no_cor   = "r = 0",
                                    low_cor  = "r = 0.3",
                                    high_cor = "r = 0.7")

# Plot the relationship between species abundances along the environment in the
# different scenarios
fig_abund_env = function(simul_df, simul_label) {
    ggplot(simul_df %>%
               filter(N >= 2), aes(patch_optim, N)) +
        geom_point(shape = ".") +
        geom_smooth() +
        facet_scenar +
        labs(x = "Environmental value",
             y = "Species Abundance (gen. = 150)",
             subtitle = simul_label)
}

# Plot the relationship between the CWM of the different trait along the
# environment for the different scenarios
fig_cwm_env = function(simul_df, simul_label) {
    simul_df %>%
        filter(N >= 2) %>%
        group_by(scenario, patch) %>%
        summarise_at(vars(contains("cwm")), sum, na.rm = TRUE) %>%
        mutate(patch_optim = gsub("patches", "", patch) %>%
                   as.numeric()) %>%
        gather("cwm_name", "cwm_value", contains("cwm")) %>%
        ggplot(aes(patch_optim, cwm_value, color = cwm_name)) +
        geom_point() +
        geom_smooth() +
        facet_scenar +
        scale_color_discrete(labels = c(trait1_cwm = "Trait 1",
                                        trait2_cwm = "Trait 2",
                                        trait3_cwm = "Trait 3")) +
        labs(x = "Environment",
             y = "Community-Weighted Mean (CWM)",
             color = NULL,
             subtitle = simul_label) +
        theme(legend.position = "top")
}

# Plot the relationship between patch CWMs along the environment considering
# total abundance
fig_cwm_env_abund = function(simul_df, simul_label, n_bins = 24,
                             given_trans = "identity") {
    simul_df %>%
        group_by(scenario, patch) %>%
        summarise_at(vars(contains("cwm"), N), sum) %>%
        mutate(patch_optim = gsub("patches", "", patch) %>%
                   as.numeric()) %>%
        gather("cwm_name", "cwm_value", contains("cwm")) %>%
        ungroup() %>%
        ggplot(aes(patch_optim, cwm_value, z = N)) +
        stat_summary_2d(bins = n_bins) +
        facet_grid(vars(scenario), vars(cwm_name),
                   labeller = labeller(scenario = label_scenar_facets,
                                       cwm_name = label_value)) +
        scale_fill_viridis_c(trans = given_trans, option = "E") +
        labs(x = "Environment",
             y = "Community-Weighted Mean (CWM)",
             fill = "Total Abundance",
             subtitle = simul_label) +
        theme(legend.position = "top")
}

# Relationship betwee, species trait values along the enviroment showing their
# local abundances for the different traits considered
fig_ind_landscape = function(simul_df, simul_label, n_bins = 22,
                             given_trans = "identity") {
    
    simul_df <- simul_df %>%
        select(-contains("cwm")) %>%
        gather("trait_name", "trait_value", contains("trait"))
    
    simul_df_cwm <- simul_df %>%
        group_by(scenario, patch, trait_name) %>%
        summarise(cwm = weighted.mean(trait_value, N))
    
    simul_df2 <- left_join(simul_df, simul_df_cwm,
                           by = c("scenario", "patch", "trait_name"))
    
    ggplot(simul_df2 %>%
               filter(N > 0),
           aes(patch_optim, trait_value, z = N)) +
        stat_summary_2d(geom = "raster", bins = n_bins, interpolate = TRUE) +
        geom_line(aes(patch_optim, cwm, color = "firebrick"), size = 1) +
        facet_grid(vars(scenario), vars(trait_name),
                   labeller = labeller(trait_name = function(x) gsub("_", " ",
                                                                     x))) +
        scale_fill_viridis_c(trans = given_trans, option = "E") +
        scale_color_manual(name = "CWM", values = c(firebrick = "grey80"),
                           labels = "") +
        labs(x = "Environment",
             y = "Trait Value",
             fill = "Species Abundance",
             subtitle = simul_label) +
        guides(colour = guide_legend(override.aes = list(size = 1,
                                                         color = "grey50"))) +
        theme(legend.position = "top")
}
```

This document presents the relationships between functional traits of species and an environmental gradient.
Refer to the `equation_only` vignette to see the development of the equation used in our model.

# Constant environmental filtering strength

## Without Competition (only intra-specific competition)

We can run the simulations without any competition `A = 0` to see if we see the theoretical patterns.


### No correlations among traits

```{r simul_no_compet_no_corr}
no_compet_no_cor <- lapply(
    trait_scenarios,
    function(x) {
        multigen(traits = uncor_traits,
                 trait_weights = x,
                 env = env,
                 time = n_gen,
                 species = n_species,
                 patches = n_patches,
                 composition = composition,
                 A = A, B = B, d = d,
                 k = k, width = env_width,
                 H = H, th_max = th_max,
                 dist_power = 2)
    })

# Takes simulation results and put them as an exploitable data.frame with only
# gen = 150 abundances
no_compet_no_cor_df = tidy_simulation_list(no_compet_no_cor,
                                           set_of_traits = uncor_traits,
                                           trait_scenarios = trait_scenarios)

no_compet_no_cor_label = paste0("Only intra comp.; ",
                                d * 100, "% dispersal;",
                                " 3 uncorrelated traits")
```

```{r no_compet_no_cor_abund_env, eval = FALSE}
plot_no_compet_no_cor_abund_env = fig_abund_env(no_compet_no_cor_df,
                                                no_compet_no_cor_label)

plot_no_compet_no_cor_abund_env
```

```{r no_compet_no_cor_cwm_env, eval = FALSE}
plot_no_compet_no_cor_cwm_env = fig_cwm_env(no_compet_no_cor_df,
                                            no_compet_no_cor_label)
plot_no_compet_no_cor_cwm_env
```

```{r no_compet_no_cor_cwm_env_abund, eval = FALSE}
plot_no_compet_no_cor_cwm_env_abund = fig_cwm_env_abund(no_compet_no_cor_df,
                                                        no_compet_no_cor_label,
                                                        given_trans = "log10")

plot_no_compet_no_cor_cwm_env_abund
```

```{r no_compet_no_cor_df_ind_landscape}
plot_no_compet_no_cor_df_ind_landscape = fig_ind_landscape(no_compet_no_cor_df,
                                                           no_compet_no_cor_label,
                                                           n_bins = 22,
                                                           given_trans = "identity")

plot_no_compet_no_cor_df_ind_landscape
```


### Low correlations among traits

```{r simul_no_compet_low_cor}
no_compet_low_cor <- lapply(
    trait_scenarios,
    function(x){
        multigen(traits = low_cor_traits,
                 trait_weights = x,
                 env = env,
                 time = n_gen,
                 species = n_species,
                 patches = n_patches,
                 composition = composition,
                 A = 0, B = B, d = d,
                 H = H, th_max = th_max,
                 k = k, width = env_width, dist_power = 2)
    })

# Takes simulation results and put them as an exploitable data.frame with only
# gen = 150 abundances
no_compet_low_cor_df = tidy_simulation_list(no_compet_low_cor,
                                            low_cor_traits,
                                            trait_scenarios)

no_compet_low_cor_label = paste0("Only intra comp.; ",
                                 d * 100, "% dispersal;",
                                 " 3 low correlated (r = 0.3) traits")
```

```{r no_compet_low_cor_df_ind_landscape}
plot_no_compet_low_cor_df_ind_landscape = fig_ind_landscape(no_compet_low_cor_df,
                                                            no_compet_low_cor_label,
                                                            n_bins = 17,
                                                            given_trans = "identity")

plot_no_compet_low_cor_df_ind_landscape
```


### High correlations among traits

```{r simul_no_compet_high_cor}
no_compet_high_cor <- lapply(
    trait_scenarios,
    function(x){
        multigen(traits = high_cor_traits,
                 trait_weights = x,
                 env = env,
                 time = n_gen,
                 species = n_species,
                 patches = n_patches,
                 composition = composition,
                 A = 0, B = B, d = d,
                 H = H, th_max = th_max,
                 k = k, width = env_width, dist_power = 2)
    })

# Takes simulation results and put them as an exploitable data.frame with only
# gen = 150 abundances
no_compet_high_cor_df = tidy_simulation_list(no_compet_high_cor,
                                             high_cor_traits,
                                             trait_scenarios)

no_compet_high_cor_label = paste0("Only intra comp.; ",
                                  d * 100, "% dispersal;",
                                  " 3 high correlated (r = 0.7) traits")
```

```{r no_compet_high_cor_df_ind_landscape}
plot_no_compet_high_cor_df_ind_landscape = fig_ind_landscape(no_compet_high_cor_df,
                                                             no_compet_high_cor_label,
                                                             n_bins = 17)

plot_no_compet_high_cor_df_ind_landscape
```


## With competition

### No correlations among traits

```{r simul_compet_no_corr}
compet_no_cor <- lapply(
    trait_scenarios,
    function(x){
        multigen(traits = uncor_traits,
                 trait_weights = x,
                 env = env,
                 time = n_gen,
                 species = n_species,
                 patches = n_patches,
                 composition = composition,
                 A = A, B = B, d = d,
                 H = H, th_max = th_max,
                 k = k, width = env_width, dist_power = 2)
    })

# Takes simulation results and put them as an exploitable data.frame with only
# gen = 150 abundances
compet_no_cor_df = tidy_simulation_list(compet_no_cor,
                                        set_of_traits = uncor_traits,
                                        trait_scenarios = trait_scenarios)

compet_no_cor_label = paste0("Competition (A = ", A, "); ",
                             d * 100, "% dispersal;",
                             " 3 uncorrelated traits")
```

```{r compet_no_cor_df_ind_landscape}
plot_compet_no_cor_df_ind_landscape = fig_ind_landscape(compet_no_cor_df,
                                                        compet_no_cor_label,
                                                        n_bins = 22)

plot_compet_no_cor_df_ind_landscape
```


### Low correlations among traits

```{r simul_compet_low_corr}
compet_low_cor <- lapply(
    trait_scenarios,
    function(x){
        multigen(traits = uncor_traits,
                 trait_weights = x,
                 env = env,
                 time = n_gen,
                 species = n_species,
                 patches = n_patches,
                 composition = composition,
                 A = A, B = B, d = d,
                 H = H, th_max = th_max,
                 k = k, width = env_width, dist_power = 2)
    })

# Takes simulation results and put them as an exploitable data.frame with only
# gen = 150 abundances
compet_low_cor_df = tidy_simulation_list(compet_low_cor,
                                         set_of_traits = low_cor_traits,
                                         trait_scenarios = trait_scenarios)

compet_low_cor_label = paste0("Competition (A = ", A, "); ",
                              d * 100, "% dispersal;",
                              " 3 correlated traits (r = 0.3)")
```

```{r compet_low_cor_df_ind_landscape}
plot_compet_low_cor_df_ind_landscape = fig_ind_landscape(compet_low_cor_df,
                                                         compet_low_cor_label,
                                                         n_bins = 17)

plot_compet_low_cor_df_ind_landscape
```


### High correlations among traits

```{r simul_compet_high_corr}
compet_high_cor <- lapply(
    trait_scenarios,
    function(x){
        multigen(traits = uncor_traits,
                 trait_weights = x,
                 env = env,
                 time = n_gen,
                 species = n_species,
                 patches = n_patches,
                 composition = composition,
                 A = A, B = B, d = d,
                 H = H, th_max = th_max,
                 k = k, width = env_width, dist_power = 2)
    })

# Takes simulation results and put them as an exploitable data.frame with only
# gen = 150 abundances
compet_high_cor_df = tidy_simulation_list(compet_high_cor,
                                          set_of_traits = high_cor_traits,
                                          trait_scenarios = trait_scenarios)

compet_high_cor_label = paste0("Competition (A = ", A, "); ",
                               d * 100, "% dispersal;",
                               " 3 correlated traits (r = 0.7)")
```

```{r compet_high_cor_df_ind_landscape}
plot_compet_high_cor_df_ind_landscape = fig_ind_landscape(compet_high_cor_df,
                                                          compet_high_cor_label,
                                                          n_bins = 17)
plot_compet_high_cor_df_ind_landscape
```

# With varying environmental filtering strength

## Without Competition (only intra-specific competition)

In this section, the environmental filtering selects for a narrower trait range
towards the end of the environmental gradient.

### No correlations among traits

```{r simul_no_compet_no_corr var_strength}

no_compet_no_cor_var <- lapply(
    trait_scenarios,
    function(x){
        multigen(traits = uncor_traits,
                 trait_weights = x,
                 env = env,
                 time = n_gen,
                 species = n_species,
                 patches = n_patches,
                 composition = composition,
                 A = 0, B = B, d = d,
                 k = k, width = var_width,
                 H = H, th_max = th_max,
                 dist_power = 2)
    })

# Takes simulation results and put them as an exploitable data.frame with only
# gen = 150 abundances
no_compet_no_cor_var_df = tidy_simulation_list(no_compet_no_cor_var,
                                               set_of_traits = uncor_traits,
                                               trait_scenarios = trait_scenarios)

no_compet_no_cor_var_label = paste0("Only intra compet; ",
                                    d * 100, "% dispersal;",
                                    " 3 uncorrelated traits")
```

```{r no_compet_no_cor_df_ind_landscape var_strength}
plot_no_compet_no_cor_df_ind_var_landscape = fig_ind_landscape(no_compet_no_cor_var_df,
                                                               no_compet_no_cor_var_label,
                                                               n_bins = 22,
                                                               given_trans = "identity")

plot_no_compet_no_cor_df_ind_var_landscape
```

### Low correlations among traits

```{r simul_no_compet_low_cor var_strength}
no_compet_low_cor_var <- lapply(
    trait_scenarios,
    function(x){
        multigen(traits = low_cor_traits,
                 trait_weights = x,
                 env = env,
                 time = n_gen,
                 species = n_species,
                 patches = n_patches,
                 composition = composition,
                 A = 0, B = B, d = d,
                 H = H, th_max = th_max,
                 k = k, width = var_width, dist_power = 2)
    })

# Takes simulation results and put them as an exploitable data.frame with only
# gen = 150 abundances
no_compet_low_cor_var_df = tidy_simulation_list(no_compet_low_cor_var,
                                                low_cor_traits,
                                                trait_scenarios)

no_compet_low_cor_var_label = paste0("Only intra compet; ",
                                     d * 100, "% dispersal;",
                                     " 3 low correlated (r = 0.3) traits")
```

```{r no_compet_low_cor_df_ind_landscape var_strength}
plot_no_compet_low_cor_df_ind_var_landscape = fig_ind_landscape(no_compet_low_cor_var_df,
                                                                no_compet_low_cor_var_label,
                                                                n_bins = 17,
                                                                given_trans = "identity")

plot_no_compet_low_cor_df_ind_var_landscape
```


### High correlations among traits

```{r simul_no_compet_high_cor var_strength}
no_compet_high_cor_var <- lapply(
    trait_scenarios,
    function(x){
        multigen(traits = high_cor_traits,
                 trait_weights = x,
                 env = env,
                 time = n_gen,
                 species = n_species,
                 patches = n_patches,
                 composition = composition,
                 A = 0, B = B, d = d,
                 H = H, th_max = th_max,
                 k = k, width = var_width, dist_power = 2)
    })

# Takes simulation results and put them as an exploitable data.frame with only
# gen = 150 abundances
no_compet_high_cor_var_df = tidy_simulation_list(no_compet_high_cor_var,
                                                 high_cor_traits,
                                                 trait_scenarios)

no_compet_high_cor_var_label = paste0("Only intra compet; ",
                                      d * 100, "% dispersal;",
                                      " 3 high correlated (r = 0.7) traits")
```

```{r no_compet_high_cor_df_ind_landscape var_strength}
plot_no_compet_high_cor_df_ind_var_landscape = fig_ind_landscape(no_compet_high_cor_var_df,
                                                                 no_compet_high_cor_var_label,
                                                                 n_bins = 17)

plot_no_compet_high_cor_df_ind_var_landscape
```


## With competition

### No correlations among traits

```{r simul_compet_no_corr var_strength}
compet_no_cor_var <- lapply(
    trait_scenarios,
    function(x){
        multigen(traits = uncor_traits,
                 trait_weights = x,
                 env = env,
                 time = n_gen,
                 species = n_species,
                 patches = n_patches,
                 composition = composition,
                 A = A, B=B, d = d,
                 H = H, th_max = th_max,
                 k = k, width = var_width, dist_power = 2)
    })

# Takes simulation results and put them as an exploitable data.frame with only
# gen = 150 abundances
compet_no_cor_var_df = tidy_simulation_list(compet_no_cor_var,
                                            set_of_traits = uncor_traits,
                                            trait_scenarios = trait_scenarios)

compet_no_cor_var_label = paste0("Competition (A = ", A, "); ",
                                 d * 100, "% dispersal;",
                                 " 3 uncorrelated traits")
```

```{r compet_no_cor_df_ind_landscape var_strength}
plot_compet_no_cor_df_ind_var_landscape = fig_ind_landscape(compet_no_cor_var_df,
                                                            compet_no_cor_var_label,
                                                            n_bins = 22)

plot_compet_no_cor_df_ind_var_landscape
```


### Low correlations among traits

```{r simul_compet_low_corr var_strength}
compet_low_cor_var <- lapply(
    trait_scenarios,
    function(x){
        multigen(traits = uncor_traits,
                 trait_weights = x,
                 env = env,
                 time = n_gen,
                 species = n_species,
                 patches = n_patches,
                 composition = composition,
                 A = A, B=B, d = d,
                 H = H, th_max = th_max,
                 k = k, width = var_width, dist_power = 2)
    })

# Takes simulation results and put them as an exploitable data.frame with only
# gen = 150 abundances
compet_low_cor_var_df = tidy_simulation_list(compet_low_cor_var,
                                             set_of_traits = low_cor_traits,
                                             trait_scenarios = trait_scenarios)

compet_low_cor_var_label = paste0("Competition (A = ", A, "); ",
                                  d * 100, "% dispersal;",
                                  " 3 correlated traits (r = 0.3)")
```

```{r compet_low_cor_df_ind_landscape var_strength}
plot_compet_low_cor_df_ind_var_landscape = fig_ind_landscape(compet_low_cor_var_df,
                                                             compet_low_cor_var_label,
                                                             n_bins = 17)

plot_compet_low_cor_df_ind_var_landscape
```


### High correlations among traits

```{r simul_compet_high_corr var_strength}
compet_high_cor_var <- lapply(
    trait_scenarios,
    function(x){
        multigen(traits = uncor_traits,
                 trait_weights = x,
                 env = env,
                 time = n_gen,
                 species = n_species,
                 patches = n_patches,
                 composition = composition,
                 A = A, B = B, d = d,
                 H = H, th_max = th_max,
                 k = k, width = var_width, dist_power = 2)
    })

# Takes simulation results and put them as an exploitable data.frame with only
# gen = 150 abundances
compet_high_cor_var_df = tidy_simulation_list(compet_high_cor_var,
                                              set_of_traits = high_cor_traits,
                                              trait_scenarios = trait_scenarios)

compet_high_cor_var_label = paste0("Competition (A = ", A, "); ",
                                   d * 100, "% dispersal;",
                                   " 3 correlated traits (r = 0.7)")
```

```{r compet_high_cor_df_ind_landscape var_strength}
plot_compet_high_cor_df_ind_var_landscape = fig_ind_landscape(compet_high_cor_var_df,
                                                              compet_high_cor_var_label,
                                                              n_bins = 17)
plot_compet_high_cor_df_ind_var_landscape
```


# Synthetic plots

## R² CWM against environment

```{r synthetic_plot, fig.width=9}
constant_df <- list(compet_no_cor_df = compet_no_cor_df,
                    compet_low_cor_df = compet_low_cor_df,
                    compet_high_cor_df = compet_high_cor_df) %>%
    # Merge as a single data.frame
    bind_rows(.id = "original_name") %>%
    # Extract comptetition and correlation status
    mutate(original_name = gsub("_df", "", original_name)) %>%
    extract(original_name, c("compet_status", "cor_level"),
            "([:alpha:]*_?compet)_(.*)")

var_df <- list(compet_no_cor_var_df = compet_no_cor_var_df,
               compet_low_cor_var_df = compet_low_cor_var_df,
               compet_high_cor_var_df = compet_high_cor_var_df) %>%
    # Merge as a single data.frame
    bind_rows(.id = "original_name") %>%
    # Extract comptetition and correlation status
    mutate(original_name = gsub("_var_df", "", original_name)) %>%
    extract(original_name, c("compet_status", "cor_level"),
            "([:alpha:]*_?compet)_(.*)")


# Combine data.frame from different environment length
all_df <- list(constant = constant_df,
               varying  = var_df) %>%
    bind_rows(.id = "env_width")

# Compute linear models for CWM <-> environment relationship
mod_df <- all_df %>%
    gather("cwm_name", "cwm_value", contains("cwm")) %>%
    group_by(env_width, compet_status, cor_level, scenario, patch, cwm_name) %>%
    summarise(patch_optim = unique(patch_optim), cwm_value = sum(cwm_value)) %>%
    group_by(env_width, compet_status, cor_level, scenario, cwm_name) %>%
    do(mod_cwm_env = lm(cwm_value ~ patch_optim, data = .)) %>%
    ungroup() %>%
    mutate(mod_glance = lapply(mod_cwm_env, broom::glance)) %>%
    unnest(mod_glance)

# R2 plot
plot_r2_cwm_env = ggplot(mod_df %>%
                             filter(!grepl("growth", cwm_name)),
                         aes(scenario, r.squared)) +
    geom_point(aes(fill = fct_rev(cor_level)),
               size = 4, position = position_dodge(width = 0.7),
               shape = 21) +
    facet_grid(rows = vars(env_width, compet_status),
               cols = vars(cwm_name),
               labeller = label_compet_env) +
    ylim(0, NA) +
    scale_fill_viridis_d("Trait\nCorrelations",
                         labels = lab_cor) +
    guides(fill = guide_legend(override.aes = list(size = 4))) +
    labs(subtitle = "R2 of trait2 CWM ~ environment",
         x = "Scenario",
         y = expression("R"^2)) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "top")

plot_r2_cwm_env

# Slope plot
mod_df %>%
    mutate(mod_tidy = lapply(mod_cwm_env, broom::tidy)) %>%
    unnest(mod_tidy) %>%
    filter(term == "patch_optim") %>%
    ggplot(aes(scenario, estimate)) +
    geom_point(aes(fill = fct_rev(cor_level)),
               size = 4, position = position_dodge(width = 0.7),
               shape = 21) +
    facet_grid(rows = vars(env_width, compet_status),
               cols = vars(cwm_name),
               labeller = label_compet_env) +
    ylim(0, 1) +
    scale_fill_viridis_d("Trait\nCorrelations", labels = lab_cor) +
    labs(subtitle = paste0("Slope of Trait 2 CWM ~ environment ",
                           "with Constant Env. Filter"),
         x = "Scenario",
         y = "Slope") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "top")
```


## Trait variance against environment

```{r link_r2_cwm_trait_var}
all_trait_var = all_df %>%
    filter(N > 0) %>%
    group_by(env_width, compet_status, cor_level, scenario, patch) %>%
    summarise_at(vars(dplyr::matches("trait[123]$")), funs(var = var(.))) %>%
    ungroup() %>%
    mutate(patch_optim = as.numeric(gsub("patches", "", patch))) %>%
    gather("trait_name", "trait_value", contains("trait"))

ggplot(all_trait_var, aes(scenario, trait_value, fill = fct_rev(cor_level))) +
    geom_boxplot() +
    facet_grid(rows = vars(env_width, compet_status),
               cols = vars(trait_name),
               labeller = label_compet_env,
               scales = "free_y") +
        scale_fill_viridis_d("Trait\nCorrelations",
                             labels = c(no_cor   = "r = 0",
                                        low_cor  = "r = 0.3",
                                        high_cor = "r = 0.7")) +
        labs(y = "Variance of trait across all patches")
```

```{r plot_trait_var_env}
plot_trait_var_env_constant = ggplot(all_trait_var %>%
                                         filter(env_width == "constant"),
                                     aes(patch_optim, trait_value,
                                         color = trait_name,
                                         linetype = compet_status)) +
    geom_line() +
    facet_grid(vars(cor_level), vars(scenario), scales = "free_y",
               labeller = labeller(scenario = label_value,
                                   cor_level = c(no_cor   = "r = 0",
                                                 low_cor  = "r = 0.3",
                                                 high_cor = "r = 0.7"))) +
    scale_color_discrete(name = "Trait",
                         labels = c(trait1_var = "Trait 1",
                                    trait2_var = "Trait 2",
                                    trait3_var = "Trait 3")) +
    scale_linetype_discrete(name = NULL,
                            labels = c(compet    = "Competition",
                                       no_compet = "Only intra comp.")) +
    labs(x = "Environment",
         y = "Trait Variance",
         subtitle = "Constant Environment") +
    theme(legend.position = "top")

plot_trait_var_env_constant

cat('\r\n\r\n')

plot_trait_var_env_varying = ggplot(all_trait_var %>%
                                        filter(env_width == "varying"),
                                    aes(patch_optim, trait_value,
                                        color = trait_name,
                                        linetype = compet_status)) +
    geom_line() +
    facet_grid(vars(cor_level), vars(scenario), scales = "free_y",
               labeller = labeller(scenario = label_value,
                                   cor_level = c(no_cor   = "r = 0",
                                                 low_cor  = "r = 0.3",
                                                 high_cor = "r = 0.7"))) +
    scale_color_discrete(name = "Trait",
                         labels = c(trait1_var = "Trait 1",
                                    trait2_var = "Trait 2",
                                    trait3_var = "Trait 3")) +
    scale_linetype_discrete(name = NULL,
                            labels = c(compet    = "Competition",
                                       no_compet = "Only intra comp.")) +
    labs(x = "Environment",
         y = "Trait Variance",
         subtitle = "Varying Environment") +
    theme(legend.position = "top")

plot_trait_var_env_varying
```

## CWV against environment

```{r cwv_envt}
var_df %>%
    select(-contains("cwm")) %>%
    filter(compet_status == "no_compet") %>%
    gather("trait_name", "trait_value", contains("trait")) %>%
    group_by(compet_status, cor_level, scenario, patch, trait_name) %>%
    summarise(trait_cwv = Weighted.Desc.Stat::w.var(trait_value, mu = N)) %>%
    mutate(patch_optim = gsub("patches", "", patch) %>%
               as.numeric()) %>%
    ggplot(aes(patch_optim, trait_cwv, color = trait_name)) +
    geom_point() +
    geom_smooth(se = FALSE) +
    facet_grid(vars(cor_level), vars(scenario), scales = "free_y",
               labeller = labeller(scenario = label_value,
                                   cor_level = c(no_cor   = "r = 0",
                                                 low_cor  = "r = 0.3",
                                                 high_cor = "r = 0.7"))) +
    scale_color_discrete(labels = c(trait1_cwm = "Trait 1",
                                    trait2_cwm = "Trait 2",
                                    trait3_cwm = "Trait 3")) +
    labs(x = "Environment",
         y = "Community-Weighted Variance (CWV)",
         color = NULL,
         subtitle = paste0("Varying environment; ",
                           d * 100, "% dispersal;",
                           " Only intra comp.")) +
    theme(legend.position = "top")

var_df %>%
    select(-contains("cwm")) %>%
    filter(compet_status == "compet") %>%
    gather("trait_name", "trait_value", contains("trait")) %>%
    group_by(compet_status, cor_level, scenario, patch, trait_name) %>%
    summarise(trait_cwv = Weighted.Desc.Stat::w.var(trait_value, mu = N)) %>%
    mutate(patch_optim = gsub("patches", "", patch) %>%
               as.numeric()) %>%
    ggplot(aes(patch_optim, trait_cwv, color = trait_name)) +
    geom_point() +
    geom_smooth(se = FALSE) +
    facet_grid(vars(cor_level), vars(scenario), scales = "free_y",
               labeller = labeller(scenario = label_value,
                                   cor_level = c(no_cor   = "r = 0",
                                                 low_cor  = "r = 0.3",
                                                 high_cor = "r = 0.7"))) +
    scale_color_discrete(labels = c(trait1_cwm = "Trait 1",
                                    trait2_cwm = "Trait 2",
                                    trait3_cwm = "Trait 3")) +
    labs(x = "Environment",
         y = "Community-Weighted Variance (CWV)",
         color = NULL,
         subtitle = paste0("Varying environment; ",
                           d * 100, "% dispersal;",
                           " Competition")) +
    theme(legend.position = "top")

```



