---
title: "Targeted set of scenarios"
author:
    - Pierre Denelle, Matthias Grenié, Cyrille Violle, François Munoz and Caroline M. Tucker
date: "`r format(Sys.time(), '%d %B %Y')`"
output: pdf_document
vignette: >
    %\VignetteIndexEntry{Full equation of the model}
    %\VignetteEncoding{UTF-8}
    %\VignetteEngine{knitr::rmarkdown}
editor_options: 
    chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      fig.width = 8, fig.height = 10.5, cache = TRUE,
                      cache.lazy = FALSE)

# Packages ---------------------------------------------------------------------
suppressPackageStartupMessages({
    suppressWarnings({
        library("tidyverse")
        library("cowplot")
        library("furrr")
        library("lme4")
        
        devtools::load_all()
    })
})

# Functions --------------------------------------------------------------------

get_predictions_along_environment = function(var_perf_df, scenario) {
    given_df = var_perf_df %>%
        filter(scenario == scenario)
    
    list(mono = given_df %>%
             filter(A == 0, B == 1e-4, H == 0, k == 1.2),
         cwm_hierarchical = given_df %>%
             filter(A == 0, B == 1e-4, H == 0.5, k == 1.2),
         cwm_limiting = given_df %>%
             filter(A == 1e-5, B == 1e-4, H == 0, k == 1.2)) %>%
        bind_rows(.id = "pred_type") %>%
        group_by(trait_cor, seed, pred_type, patch) %>%
        summarise(trait1_weight = weighted.mean(trait1, N150),
                  trait2_weight = weighted.mean(trait2, N150)) %>%
        ungroup() %>%
        mutate(pred_type = factor(pred_type, c("mono",
                                               "cwm_hierarchical",
                                               "cwm_limiting")),
               trait_cor = factor(trait_cor, c("negcor",
                                               "uncor",
                                               "poscor"))) %>%
        gather("trait_name", "trait_value", trait1_weight, trait2_weight)
}

plot_predictions_along_environment = function(perf_along_env_df) {
    perf_along_env_df %>%
        ggplot(aes(patch, trait_value, color = pred_type)) +
        geom_abline(slope = 1, intercept = 0, linetype = 2) +
        geom_line(aes(group = interaction(seed, pred_type)), size = 1,
                  alpha = 1/5) +
        geom_smooth(method = "lm", se = TRUE, size = 1) +
        facet_grid(vars(trait_cor),
                   vars(trait_name),
                   labeller = labeller(
                       trait_cor = c(negcor = "Negative Correlation",
                                     uncor  = "Uncorrelated",
                                     poscor = "Positive Correlation"),
                       trait_name = c(trait1_weight = "Trait 1",
                                      trait2_weight = "Trait 2"))) +
        ylim(0, 25) +
        scale_color_discrete(
            labels = c(indiv            = "Individual",
                       mono             = "Monoculture",
                       cwm_hierarchical = "CWM with\nHierarch. Compet.",
                       cwm_limiting     = "CWM with\nLimit. Sim.")) +
        labs(x = "Environment",
             y = "Trait",
             color = "Performance\nType") +
        theme(aspect.ratio = 1,
              legend.position = "top")
}

plot_mod_estimate_along_env = function(mod_df) {
    mod_df %>%
        mutate(br = map(lin_mod, broom::tidy, conf.int = TRUE)) %>%
        unnest(br) %>%
        filter(effect == "fixed") %>%
        ggplot(aes(pred_type, estimate, color = trait_name)) +
        geom_hline(yintercept = 0, linetype = 2) +
        geom_pointrange(aes(ymin = conf.low,
                            ymax = conf.high),
                        position = position_dodge(0.5)) +
        facet_grid(vars(trait_cor), vars(term),
                   labeller = labeller(
                       trait_cor = c(negcor = "Negative Correlation",
                                     uncor  = "Uncorrelated",
                                     poscor = "Positive Correlation"),
                       term = c(`(Intercept)` = "Intercept",
                                trait_value   = "slope")),
                   scales = "free_x") +
        coord_flip() +
        labs(x = "Slope Estimate",
             y = "Prediction Type",
             subtitle = "Estimate with 95% CI intervals") +
        scale_x_discrete(
            labels = c(mono             = "Monoculture",
                       cwm_hierarchical = "CWM with\nHierarch. Compet.",
                       cwm_limiting     = "CWM with\nLimit. Sim.")) +
        scale_color_discrete(labels = c(trait1_weight = "Trait 1",
                                      trait2_weight = "Trait 2"))
}
# Other ------------------------------------------------------------------------
plan(multiprocess, workers = 14)
```

Actual scenarios

```{r parameters}
list_A = c(0, 10^-(c(4, 5)))
list_k = c(1.2, 1.5)
list_B = list_A
list_H = c(0, 0.5)
n_seed = 10
n_patches = 25
n_species = 100
n_gen = 50
```

```{r simulation}
# Generate all scenarios
single_trait = data.frame(trait = paste0("trait", 1:2),
                          growth_weight    = c(1, 0),
                          compet_weight    = c(1, 0),
                          hierarchy_weight = c(1, 0))

two_traits_R = data.frame(trait = paste0("trait", 1:2),
                          growth_weight    = c(0.5, 0.5),
                          compet_weight    = c(0,   0),
                          hierarchy_weight = c(0,   0))

two_traits_each = data.frame(trait = paste0("trait", 1:2),
                             growth_weight    = c(1, 0),
                             compet_weight    = c(0, 1),
                             hierarchy_weight = c(0, 1))

two_traits_all  = data.frame(trait = paste0("trait", 1:2),
                             growth_weight    = c(0.5, 0.5),
                             compet_weight    = c(0.5, 0.5),
                             hierarchy_weight = c(0.5, 0.5))
scenar_list = list(R0A0H0     = single_trait,
                   R50A0H0    = two_traits_R,
                   R0A100H100 = two_traits_each,
                   R50A50H50  = two_traits_all)

# Generate trait matrices for each seed
fixed_coef = 0.3
trait_seeds = lapply(seq(n_seed), function(seed) {
    set.seed(seed)
    list(
        uncor  = generate_cor_traits(n_patches, n_species, 1, cor_coef = 0),
        poscor = generate_cor_traits(n_patches, n_species, 1,
                                     cor_coef = fixed_coef),
        negcor = generate_cor_traits(n_patches, n_species, 1,
                                     cor_coef = -fixed_coef)
    )
})
# multidimensional matrix
composition <- array(NA, dim = c(n_patches, n_species, n_gen),
                     dimnames = list(paste0("patches", seq(n_patches)),
                                     paste0("species", seq(n_species)),
                                     paste0("time", seq(n_gen))))

composition[,,1] = 50

# Actual simulations -----------------------------------------------------------
param_sets = list(
    run_n = seq(n_seed),
    A     = list_A,
    k     = list_k,
    B     = list_B,
    H     = list_H) %>%
    # Make all combinations but exclude cases where A > B
    cross(.filter = ~(..2 > ..4) | ((..2 != 0 & ..5 != 0)))

tictoc::tic()

var_param = future_map(param_sets, function(x) {
    suppressMessages({
        devtools::load_all()
    })

    meta_simul(seed_number = x$run_n,
               given_k = x$k,
               given_A = x$A,
               given_B = x$B,
               given_scenars = scenar_list,
               given_H = x$H,
               given_traits = trait_seeds[[x$run_n]],
               given_h_fun = "sum",
               given_di_thresh = 24,
               given_env = 1:25,
               given_composition = composition,
               given_d = 0.05)
}, .progress = TRUE)
tictoc::toc()

# All Traits -------------------------------------------------------------------

full_trait_df = map_dfr(trait_seeds, function(x) {
    map_dfr(x, ~.x %>%
                as.data.frame() %>%
                rownames_to_column("species"),
            .id = "trait_cor")
},.id = "seed") %>%
    mutate(seed = as.integer(seed))

# Extract performances indices -------------------------------------------------

tictoc::tic()
var_perfs = future_map_dfr(unlist(var_param, recursive = FALSE),
                          ~extract_performances_from_simul(.x, trait_seeds,
                                                           TRUE))
tictoc::toc()

var_perfs = var_perfs %>%
    mutate(scenario = case_when(R_scenar ==  0 & A_scenar ==   0 &
                                    H_scenar ==   0 ~ "R0A0H0",
                                R_scenar == 50 & A_scenar ==   0 &
                                    H_scenar ==   0 ~ "R50A0H0",
                                R_scenar ==  0 & A_scenar == 100 &
                                    H_scenar == 100 ~ "R0A100H100",
                                R_scenar == 50 & A_scenar ==  50 &
                                    H_scenar ==  50 ~ "R50A50H50")) %>%
    inner_join(full_trait_df, by = c("trait_cor", "seed", "species"))



n_simul = length(param_sets)
```

```{r first_scenario}
first_scenar = get_predictions_along_environment(var_perfs, "R0A0H0")

fig_first_scenar = first_scenar %>%
    filter(trait_name == "trait1_weight", trait_cor == "uncor") %>%
    plot_predictions_along_environment() +
    labs(title = "Trait 1 contributing to all processes") +
    theme(strip.text = element_blank())

first_mod = first_scenar %>%
    filter(trait_cor == "uncor", trait_name == "trait1_weight") %>%
    nest(-pred_type) %>%
    mutate(lin_mod = map(data, ~lmer(patch ~ trait_value + (1|seed), data =.)))
```

```{r second_scenario}
second_scenar = get_predictions_along_environment(var_perfs, "R50A0H0")

fig_second_scenar = second_scenar %>%
    plot_predictions_along_environment() +
    labs(title = "Both Traits contributing 50% to Growth")

second_mod = second_scenar %>%
    nest(-trait_name, -trait_cor, -pred_type) %>%
    mutate(lin_mod = map(data, ~lme4::lmer(patch ~ trait_value + (1|seed),
                                           data =.)))

fig_second_mod = plot_mod_estimate_along_env(second_mod)
```


```{r third_scenario}
third_scenar = get_predictions_along_environment(var_perfs, "R100A0H100")

fig_third_scenar = third_scenar %>%
    plot_predictions_along_environment() +
    labs(title = "Trait 1 = 100% Growth; Trait 2 = 100% Competition")

third_mod = third_scenar %>%
    nest(-trait_name, -trait_cor, -pred_type) %>%
    mutate(lin_mod = map(data, ~lme4::lmer(patch ~ trait_value + (1|seed), data =.)))

fig_third_mod = plot_mod_estimate_along_env(third_mod)
```

```{r fourth_scenario}
fourth_scenar = get_predictions_along_environment(var_perfs, "R50A50H50")

fig_fourth_scenar = fourth_scenar %>%
    plot_predictions_along_environment() +
    labs(title = "Both Traits contributing equally to all processes")

fourth_mod = fourth_scenar %>%
    nest(-trait_name, -trait_cor, -pred_type) %>%
    mutate(lin_mod = map(data, ~lmer(patch ~ trait_value + (1|seed), data =.)))

fig_fourth_mod = plot_mod_estimate_along_env(fourth_mod)
```
